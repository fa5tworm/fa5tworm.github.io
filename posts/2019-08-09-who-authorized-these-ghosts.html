<!DOCTYPE html>
<html>
  
<!-- Mirrored from blog.ocharles.org.uk/posts/2019-08-09-who-authorized-these-ghosts.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 01 Aug 2024 22:56:51 GMT -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Who Authorized These Ghosts!?</title>
    <!-- <link rel="stylesheet" type="text/css" href="/css/reset.css" /> -->
    <!-- <link rel="stylesheet" type="text/css" href="/css/typography.css" /> -->
    <link rel="stylesheet" type="text/css" href="../css/syntax-highlighting.css" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="../posts.rss">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:300,100" rel="stylesheet" type="text/css">
    <style>
    /*! Typebase.less v0.1.0 | MIT License */
    /* Setup */
    html {
      /* Change default typefaces here */
      font-size: 125%;
      -webkit-font-smoothing: antialiased;
      font-family: 'Roboto Slab', serif;
      font-weight: 300;
    }
    /* Copy & Lists */
    p, pre {
      line-height: 1.5rem;
      margin-top: 1.5rem;
      margin-bottom: 0;
    }
    ul,
    ol {
      margin-top: 1.5rem;
      margin-bottom: 1.5rem;
    }
    ul li,
    ol li {
      line-height: 1.5rem;
    }
    ul ul,
    ol ul,
    ul ol,
    ol ol {
      margin-top: 0;
      margin-bottom: 0;
    }
    blockquote {
      line-height: 1.5rem;
      margin-top: 1.5rem;
      margin-bottom: 1.5rem;
    }
    /* Headings */
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      /* Change heading typefaces here */
      font-weight: 100;
      margin-top: 1.5rem;
      margin-bottom: 0;
      line-height: 1.5rem;
    }
    h1 {
      font-size: 3.242rem;
      line-height: 4.5rem;
      margin-top: 3rem;
      text-align: center;
      padding-bottom: 1.5rem;
    }
    h2 {
      font-size: 2.828rem;
      line-height: 3rem;
      margin-top: 3rem;
    }
    h3 {
      font-size: 1.414rem;
    }
    h4 {
      font-size: 0.707rem;
    }
    h5 {
      font-size: 0.4713333333333333rem;
    }
    h6 {
      font-size: 0.3535rem;
    }
    /* Tables */
    table {
      margin-top: 1.5rem;
      border-spacing: 0px;
      border-collapse: collapse;
    }
    table td,
    table th {
      padding: 0;
      line-height: 33px;
    }
    /* Leading paragraph text */
    .lead {
      font-size: 1.414rem;
    }
    /* Hug the block above you */
    .hug {
      margin-top: 0;
    }

    html {
      background: #eae3cb;
    }
    body {
      background-color: #fcf4dc;
      width: 40em;
      margin: 0 auto 2em;
      padding: 2em 3em;
      border: 1px solid #d9d2ba;
      border-top: none;
      color: #111;
    }
    h1 {
      border-bottom: 1px solid #555;
      /*text-align: center;
      padding-bottom: 10px;*/
    }
    /* h2,h3 { margin-top: 2em } */
    ul#icons {
      position: absolute;
      top: 10px;
      right: 10px;
      list-style-type: none;
      text-align: right;
    }
    ul#icons img { width: 16px; vertical-align: middle; }
    ul#icons a { color: transparent; font-style: italic; font-size: small; }
    ul#icons li:hover a { color: #aaa; text-decoration: none !important}
    #TOC { display: none; }
    pre {
      border-bottom: 1px dotted #d9d2ba;
      border-top: 1px dotted #d9d2ba;
    }
     a {
         text-decoration: none;
     }
    </style>
  </head>
  <body>
    <h1>Who Authorized These Ghosts!?</h1>
<p>Recently at <a href="http://circuithub.com/">CircuitHub</a> we’ve been making some changes to how we develop our APIs. We previously used <a href="https://www.yesodweb.com/">Yesod</a> with a custom router, but we’re currently exploring <a href="https://hackage.haskell.org/package/servant">Servant</a> for API modelling, in part due to it’s potential for code generation for other clients (e.g., our <a href="http://elm-lang.org/">Elm</a> frontend). Along the way, this is requiring us to rethink and reinvent previously established code, and one of those areas is authorization.</p>
<p>To recap, <a href="https://en.wikipedia.org/wiki/Authorization">authorization is</a></p>
<blockquote>
<p>the function of specifying access rights/privileges to resources related to information security and computer security in general and to access control in particular.</p>
</blockquote>
<p>This is in contrast to <em>authentication</em>, which is the act of showing that someone is who they claim to be.</p>
<p>Authorization is a very important process, especially in a business like CircuitHub where we host many confidential projects. Accidentally exposing this data could be catastrophic to both our business and customers, so we take it <em>very</em> seriously.</p>
<p>Out of the box, Servant has experimental support for authorization, which is a good start. <code>servant-server</code> gives us <a href="https://hackage.haskell.org/package/servant-server-0.16.2/docs/Servant-Server-Experimental-Auth.html"><code>Servant.Server.Experimental.Auth</code></a> which makes it a doddle to plug in our existing authorization mechanism (cookies &amp; Redis). But that only shows that we know <em>who</em> is asking for resources, how do we check that they are <em>allowed</em> to access the resources?</p>
<p>As a case study, I want to have a look at a particular end-point, <code>/projects/:id/price</code>. This endpoint calculates the pricing options CircuitHub can offer a project, and there are few important points to how this endpoint works:</p>
<ol type="1">
<li>The pricing for a project depends on the user viewing it. This is because some users can consign parts so CircuitHub won’t order them. Naturally, this affects the price, so pricing is viewer dependent.</li>
<li>Some projects are owned by organizations, and should be priced by the organization as a whole. If a user is a member of the organization that owns the project pricing has been requested for, return the pricing for the organization. If the user is not in the organization, return their own custom pricing.</li>
<li>Private projects should only expose their pricing to superusers, the owner of the project, and any members of the project’s organization (if it’s owned by an organization).</li>
</ol>
<p>This specification is messy and complicated, but that’s just reality doing it’s thing.</p>
<p>Our first approach was to try and represent this in Servant’s API type. We start with the “vanilla” route, with no authentication or authorization:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">API</span> <span class="ot">=</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;projects&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="dt">Capture</span> <span class="st">&quot;id&quot;</span> <span class="dt">ProjectId</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="st">&quot;price&quot;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="dt">Get</span> '[ <span class="dt">JSON</span> ] <span class="dt">Pricing</span></span></code></pre></div>
<p>Next, we add authorization:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">API</span> <span class="ot">=</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">AuthProtect</span> <span class="dt">CircuitHub</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="st">&quot;projects&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="dt">Capture</span> <span class="st">&quot;id&quot;</span> <span class="dt">ProjectId</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="st">&quot;price&quot;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="dt">Get</span> '[ <span class="dt">JSON</span> ] <span class="dt">Pricing</span></span></code></pre></div>
<p>At this point, we’re on our own - Servant offers no authorization primitives (though there are <a href="https://github.com/haskell-servant/servant-auth/issues/73">discussions</a> on this topic).</p>
<p>My first attempt to add authorization to this was:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">API</span> <span class="ot">=</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">AuthorizeWith</span> ( <span class="dt">AuthProtect</span> <span class="dt">CircuitHub</span> )</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="st">&quot;projects&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="dt">CanView</span> ( <span class="dt">Capture</span> <span class="st">&quot;id&quot;</span> <span class="dt">ProjectId</span> )</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="st">&quot;price&quot;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="dt">Get</span> '[ <span class="dt">JSON</span> ] <span class="dt">Pricing</span></span></code></pre></div>
<p>There are two new routing combinators here: <code>AuthorizeWith</code> and <code>CanView</code>. The idea is <code>AuthorizeWith</code> somehow captures the result of authenticating, and provides that information to <code>CanView</code>. <code>CanView</code> itself does some kind of authorization using a type class based on its argument - here <code>Capture "id" ProjectId</code>. The result is certainly something that worked, but I was unhappy with both the complexity to implement it (which is scope to get it wrong), and the lack of actual evidence of authorization.</p>
<p>The latter point needs some expanding. What I mean by “lacking evidence” is that with the current approach, the authorization is essentially like writing the following code:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  checkAuthorization</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  doThings</span></code></pre></div>
<p>If I later add more resource access into <code>doThings</code>, what will hold me accountable to checking authorization on those resources? The answer is… nothing! This is similar to <a href="https://existentialtype.wordpress.com/2011/03/15/boolean-blindness/">boolean blindless</a> - we performed logical check, only to throw all the resulting evidence away immediately.</p>
<p>At this point I wanted to start exploring some different options. While playing around with ideas, I was reminded of the wonderful paper “<a href="https://kataskeue.com/gdp.pdf">Ghosts of Departed Proofs</a>”, and it got me thinking… can we use these techniques for authorization?</p>
<h2 id="ghosts-of-departed-proofs">Ghosts of Departed Proofs</h2>
<p>The basic idea of GDP is to name values using higher-rank quantification, and then - in trusted modules - produce proofs that refer to these names. To name values, we introduce a <code>Named</code> type, and the higher-ranked function <code>name</code> to name things:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Named</span> ( <span class="dt">Named</span>, forgetName, name ) <span class="kw">where</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Named</span> n a <span class="ot">=</span> <span class="dt">Named</span> {<span class="ot"> forgetName ::</span> a }</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ot">name ::</span> a <span class="ot">-&gt;</span> ( <span class="kw">forall</span> name<span class="op">.</span> <span class="dt">Named</span> name a <span class="ot">-&gt;</span> r ) <span class="ot">-&gt;</span> r</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>name x f <span class="ot">=</span> f ( <span class="dt">Named</span> x )</span></code></pre></div>
<p>Note that the <em>only</em> way to construct a <code>Named</code> value outside of this module is to use <code>name</code>, which introduces a completely distinct name for a limited scope. Within this scope, we can construct proofs that refer to these names. As a basic example, we could use GDP to prove that a number is prime:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Prime</span> ( <span class="dt">IsPrime</span>, checkPrime ) <span class="kw">where</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">IsPrime</span> name <span class="ot">=</span> <span class="dt">IsPrime</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ot">checkPrime ::</span> <span class="dt">Named</span> name <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">IsPrime</span> name)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>checkPrime named <span class="op">|</span> isPrime (forgetName named) <span class="ot">=</span> <span class="dt">Just</span> <span class="dt">IsPrime</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                 <span class="op">|</span> <span class="fu">otherwise</span>                  <span class="ot">=</span> <span class="dt">Nothing</span></span></code></pre></div>
<p>Here we have our first proof witness - <code>IsPrime</code>. We can witness whether or not a named <code>Int</code> is prime using <code>checkPrime</code> - like the boolean value <code>isPrime</code> this determines if a number is or isn’t prime, but we get evidence that we’ve checked a <em>specific</em> value for primality.</p>
<p>This is the whirlwind tour of GDP, I highly recommend reading the paper for a more thorough explanation. Also, the library <a href="https://hackage.haskell.org/package/justified-containers"><code>justified-containers</code></a> explores these ideas in the context of maps, where we have proofs that specific items are in the map (giving us total lookups, rather than partial lookups).</p>
<h2 id="gdp-and-authorization">GDP and Authorization</h2>
<p>This is all well and good, but how does this help with authorization? The basic idea is that authorization is itself a proof - a proof that we can view or interact with resources in a particular way. First, we have to decide which functions need authorization - these functions will be modified to require proof values the refer to the function arguments. In this example, we’ll assume our Servant handler is going to itself make a call to the <code>price :: ProjectId -&gt; UserId -&gt; m Price</code> function. However, given the specification above, we need to make sure that user and project are compatible. To do this, we’ll name the arguments, and then introduce a proof that the user in question can view the project:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>price</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">Named</span> projectId <span class="dt">ProjectId</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> <span class="dt">Named</span> userId <span class="dt">UserId</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> userId <span class="ot">`CanViewProject`</span> projectId</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> m <span class="dt">Price</span></span></code></pre></div>
<p>But what is this <code>CanViewProject</code> proof?</p>
<p>A first approximation is to treat it as some kind of primitive or axiom. A blessed function can postulate this proof with no further evidence:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">CanViewProject</span> ( <span class="dt">CanViewProject</span>, canViewProject ) <span class="kw">where</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">CanViewProject</span> userId projectId <span class="ot">=</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">TrustMe</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>canViewProject</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">Named</span> projectId <span class="dt">ProjectId</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> <span class="dt">Named</span> userId <span class="dt">UserId</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> m ( <span class="dt">Maybe</span> ( <span class="dt">CanViewProject</span> userId projectId ) )</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>canViewProject <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- ... lots of database access/IO</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> <span class="op">...</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">then</span> <span class="fu">return</span> ( <span class="dt">Just</span> <span class="dt">TrustMe</span> )</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="fu">return</span> <span class="dt">Nothing</span></span></code></pre></div>
<p>This is a good start! Our <code>price</code> function can only be called with a <code>CanViewProject</code> that matches the named arguments, and the only way to construct such a value is to use <code>canViewProject</code>. Of course we could get the implementation of <em>this</em> wrong, so we should focus our testing efforts to make sure it’s doing the right thing.</p>
<p>However, the Agda programmer in me is a little unhappy about just blindly postulating <code>CanViewProject</code> at the end. We’ve got a bit of vision back from our boolean blindness, but the landscape is still blurry. Fortunately, all we have to do is recruit more of the same machinery so far to subdivide this proof into smaller ones:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">ProjectIsPublic</span> ( <span class="dt">ProjectIsPublic</span>, projectIsPublic ) <span class="kw">where</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">ProjectIsPublic</span> project <span class="ot">=</span> <span class="dt">TrustMe</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>projectIsPublic</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">Named</span> projectId <span class="dt">ProjectId</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> m ( <span class="dt">Maybe</span> ( <span class="dt">ProjectIsPublic</span> projectId ) )</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">UserBelongsToProjectOrganization</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  ( <span class="dt">UserBelongsToProjectOrganization</span>, userBelongsToProjectOrganization )</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">UserBelongsToProjectOrganization</span> user project <span class="ot">=</span> <span class="dt">TrustMe</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>userBelongsToProjectOrganization</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">Named</span> userId <span class="dt">UserId</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> <span class="dt">Named</span> projectId <span class="dt">ProjectId</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> m ( <span class="dt">Maybe</span> ( <span class="dt">UserBelongsToProjectOrganization</span> userId projectId ) )</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">UserIsSuperUser</span> ( <span class="dt">UserIsSuperUser</span>, userIsSuperUser ) <span class="kw">where</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">UserIsSuperUser</span> user <span class="ot">=</span> <span class="dt">TrustMe</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ot">userIsSuperUser ::</span> <span class="dt">Named</span> userId <span class="dt">UserId</span> <span class="ot">-&gt;</span> m ( <span class="dt">Maybe</span> ( <span class="dt">UserIsSuperUser</span> userId ) )</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">UserOwnsProject</span> ( <span class="dt">UserOwnsProject</span>, userOwnsProject ) <span class="kw">where</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">UserOwnsProject</span> user project <span class="ot">=</span> <span class="dt">TrustMe</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>userOwnsProject</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">Named</span> userId <span class="dt">UserId</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> <span class="dt">Named</span> projectId <span class="dt">ProjectId</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> m ( <span class="dt">Maybe</span> ( <span class="dt">UserOwnsProject</span> userId projectId ) )</span></code></pre></div>
<p>Armed with these smaller authorization primitives, we can build up our richer authorization scheme:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">CanViewProject</span> <span class="kw">where</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">CanViewProject</span> userId projectId</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">ProjectIsPublic</span> (<span class="dt">ProjectIsPublic</span> projectId)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">UserOwnsProject</span> (<span class="dt">UserOwnsProject</span> userId projectId)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">UserIsSuperUser</span> (<span class="dt">UserIsSuperUser</span> userId)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">UserBelongsToProjectOrganization</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      (<span class="dt">UserBelongsToProjectOrganization</span> userId projectId)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>canViewProject</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">Named</span> userId <span class="dt">UserId</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> <span class="dt">Named</span> projectId <span class="dt">ProjectId</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> m ( <span class="dt">Maybe</span> ( <span class="dt">CanViewProject</span> userId projectId ) )</span></code></pre></div>
<p>Now <code>canViewProject</code> just calls out to the other authorization routines to build it’s proof. Furthermore, there’s something interesting here. <code>CanViewProject</code> doesn’t postulate anything - everything is attached with a proof of the particular authorization case. This means that we can actually open up the whole <code>CanViewProject</code> module to the world - there’s no need to keep anything private. By doing this and allowing people to pattern match on <code>CanViewProject</code>, authorization results become reusable - if something else only cares that a user is a super user, we might be able to pull this directly out of <code>CanViewProject</code> - no need for any redundant database checks!</p>
<p>In fact, this very idea can help us implement the final part of our original specification:</p>
<blockquote>
<p>Some projects are owned by organizations, and should be priced by the organization as a whole. If a user is a member of the organization that owns the project pricing has been requested for, return the pricing for the organization. If the user is not in the organization, return their own custom pricing.</p>
</blockquote>
<p>If we refine our <code>UserBelongsToProjectOrganization</code> proof, we can actually maintain a bit of extra evidence:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">UserBelongsToProjectOrganization</span> userId projectId <span class="kw">where</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">UserBelongsToProjectOrganization</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> {<span class="ot"> projectOrganizationId ::</span> <span class="dt">Named</span> orgId <span class="dt">UserId</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>       ,<span class="ot"> organizationOwnsProject ::</span> <span class="dt">UserOwnsProject</span> orgId projectId</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>       }</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">UserBelongsToProjectOrganization</span> userId projectId</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>withUserBelongsToProjectOrganizationEvidence</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">UserBelongsToProjectOrganization</span> userId projectId</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> ( <span class="kw">forall</span> orgId<span class="op">.</span> <span class="dt">Named</span> orgId <span class="dt">UserId</span> <span class="ot">-&gt;</span> <span class="dt">UserOwnsProject</span> orgId projectId <span class="ot">-&gt;</span> r )</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> r</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>withUserBelongsToProjectOrganizationEvidence <span class="dt">UserBelongsToProjectOrganization</span>{<span class="op">..</span>} k <span class="ot">=</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  k projectOrganizationId organizationOwnsProject</span></code></pre></div>
<p>Now whenever we have a proof <code>UserBelongsToProjectOrganization</code>, we can pluck out the actual organization that we’re talking about. We also have evidence that the organization owns the project, so we can easily construct a new <code>CanViewProject</code> proof - proofs generate more proofs!</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>price</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">Named</span> projectId <span class="dt">ProjectId</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> <span class="dt">Named</span> userId <span class="dt">UserId</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> userId <span class="ot">`CanViewProject`</span> projectId</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> m <span class="dt">Price</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>price projectId userId <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">UserBelongsToProjectOrganization</span> proof <span class="ot">-&gt;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    withUserBelongsToProjectOrganizationEvidence proof \orgId ownership <span class="ot">-&gt;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>      price projectId orgId (<span class="dt">UserOwnsProject</span> ownership)</span></code></pre></div>
<h2 id="relationship-to-servant">Relationship to Servant</h2>
<p>At the start of this post, I mentioned that the goal was to integrate this with Servant. So far, we’ve looked at adding authorization to a single function, so how does this interact with Servant? Fortunately, it requires very little to change. The Servant API type is authorization free, but does mention authentication.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">API</span> <span class="ot">=</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">AuthProtect</span> <span class="dt">CircuitHub</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="st">&quot;projects&quot;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="dt">Capture</span> <span class="st">&quot;id&quot;</span> <span class="dt">ProjectId</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="st">&quot;price&quot;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">:&gt;</span> <span class="dt">Get</span> '[ <span class="dt">JSON</span> ] <span class="dt">Pricing</span></span></code></pre></div>
<p>It’s only when we need to call our <code>price</code> function do we need to have performed some authorization, and this happens in the server-side handler. We do this by naming the respective arguments, witnessing the authorization proof, and then calling <code>price</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ot">priceProject ::</span> <span class="dt">User</span> <span class="ot">-&gt;</span> <span class="dt">ProjectId</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Pricing</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>priceProject user projectId <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  name (userId user) \namedUserId <span class="ot">-&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  name projectId \namedProjectId <span class="ot">-&gt;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    canViewProjectProof <span class="ot">&lt;-</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>      canViewProject namedUserId namedProjectId</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> mcanViewProjectProof <span class="kw">of</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Nothing</span> <span class="ot">-&gt;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fail</span> <span class="st">&quot;Authorization failed&quot;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Just</span> granted <span class="ot">-&gt;</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        price namedProjectId namedUserId granted</span></code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>That’s where I’ve got so far. It’s early days so far, but the approach is promising. What I really like is there is almost a virtual slider between ease and rigour. It can be easy to get carried away, naming absolutely everything and trying to find the most fundamental proofs possible. I’ve found so far that it’s better to back off a little bit - are you <em>really</em> going to get some set membership checks wrong? Maybe. But a property check is probably gonig to be enough to keep that function in check. We’re <em>not</em> in a formal proof engine setting, pretending we are just makes things harder than they need to be.</p>
<hr />
<p style="font-style: italic">You can contact me via email
at <a href="mailto:ollie@ocharles.org.uk">ollie@ocharles.org.uk</a> or tweet to
me <a href="http://twitter.com/acid2">@acid2</a>. I share almost all of my work
at <a href="http://github.com/ocharles">GitHub</a>.
  This <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" rel="dct:type">post</span> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License</a>.</p>
<hr />

    <ul id="icons">
      <li>
        <a href="https://coderwall.com/ocharles">
          <img alt="Endorse ocharles on Coderwall" src="http://api.coderwall.com/ocharles/endorsecount.png" style="width: auto" /></a></li>
      <li>
        <a href="http://twitter.com/acid2">Twitter
          <img src="../img/twitter.ico" /></a></li>
      <li>
        <a href="https://alpha.app.net/ocharles">App.net
          <img src="../img/adn.ico" /></a></li>
      <li>
        <a href="http://github.com/ocharles">GitHub
          <img src="../img/github.ico" /></a></li>
      <li>
        <a href="http://musicbrainz.org/user/acid2">MusicBrainz
          <img src="../img/musicbrainz.ico" /></a></li>
      <li>
        <a href="http://last.fm/user/acid2">Last.fm
          <img src="../img/lastfm.ico" /></a></li>
      <li>
        <a href="http://www.goodreads.com/user/show/8961303-oliver-charles">
          GoodReads <img src="../img/goodreads.ico" /></a></li>
      <li>
        <a href="http://www.soundcloud.com/bifurcations">
          SoundCloud (experimental) <img src="../img/soundcloud.ico" /></a></li>
      <li>
        <a href="http://www.soundcloud.com/cycles">
          SoundCloud (older work) <img src="../img/soundcloud.ico" /></a></li>
      <li>
        <a href="../posts.rss">RSS (posts)
          <img src="../img/rss.svg" /></a></li>
    </ul>
  </body>

<!-- Mirrored from blog.ocharles.org.uk/posts/2019-08-09-who-authorized-these-ghosts.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 01 Aug 2024 22:56:51 GMT -->
</html>
